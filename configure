#!/bin/sh
# configure script for CRAN-safe fallback static linking of GMP, CLN, and GiNaC
# with explicit C++14 standard

set -e

ARCH=${R_ARCH}
if [ -z "$ARCH" ]; then
  ARCH=$(uname -m)
fi

echo "Detected architecture: $ARCH"

CPPFLAGS=""
LDFLAGS=""

# Utility to filter out unwanted flags
filter_flags() {
  echo "$1" | tr ' ' '\n' | grep -vE '^[-]W$' | tr '\n' ' '
}

if command -v pkg-config >/dev/null 2>&1; then
  echo "Using pkg-config to locate libraries..."

  if pkg-config --exists gmp cln ginac; then
    echo "  Found GMP, CLN, and GiNaC"
    PKG_FLAGS=$(pkg-config --cflags --libs gmp cln ginac)
    CPPFLAGS=$(filter_flags "$PKG_FLAGS")
    LDFLAGS=$(pkg-config --libs gmp cln ginac)
  else
    echo "  pkg-config installed but required packages not found. Falling back to bundled libs."
    USE_FALLBACK=1
  fi
else
  echo "pkg-config not available. Falling back to bundled libs."
  USE_FALLBACK=1
fi

if [ "$USE_FALLBACK" = "1" ]; then
  CPPFLAGS="-I../inst/include"
  LDFLAGS="../inst/libs/$ARCH/libgmp.a ../inst/libs/$ARCH/libcln.a ../inst/libs/$ARCH/libginac.a"
fi

# Append C++14 standard to flags
CPPFLAGS="$CPPFLAGS $CXX14STD"

# Remove duplicate linker flags
LDFLAGS=$(echo "$LDFLAGS" | tr ' ' '\n' | awk '!seen[$0]++' | tr '\n' ' ')

# Write Makevars for Unix/macOS
cat <<EOF > src/Makevars
CXX_STD = CXX14
PKG_CPPFLAGS = $CPPFLAGS
PKG_LIBS = $LDFLAGS
EOF

# Write Makevars.win for Windows
cat <<EOF > src/Makevars.win
CXX_STD = CXX14
PKG_CPPFLAGS = $CPPFLAGS
PKG_LIBS = $LDFLAGS
EOF

echo "Configuration complete. Flags: $CPPFLAGS $LDFLAGS"
