#!/bin/sh
# configure script for CRAN-safe dynamic linking of GMP, CLN, and GiNaC

set -e

# Check for pkg-config
if ! command -v pkg-config >/dev/null 2>&1; then
  echo "Error: pkg-config is not installed. Please install it to proceed."
  exit 1
fi

# Initialize flags
CPPFLAGS=""
LDFLAGS=""

filter_flags() {
  echo "$1" | tr ' ' '\n' | grep -vE '^[-]W$' | tr '\n' ' '
}

echo "Checking for GMP..."
if pkg-config --exists gmp; then
  echo "  Found GMP"
  gmp_cflags=$(filter_flags "$(pkg-config --cflags gmp)")
  gmp_libs="$(pkg-config --libs gmp)"
  CPPFLAGS="$CPPFLAGS $gmp_cflags"
  LDFLAGS="$LDFLAGS $gmp_libs"
else
  echo "  GMP not found. Please install libgmp-dev."
  exit 1
fi

echo "Checking for CLN..."
if pkg-config --exists cln; then
  echo "  Found CLN"
  cln_cflags=$(filter_flags "$(pkg-config --cflags cln)")
  cln_libs="$(pkg-config --libs cln)"
  CPPFLAGS="$CPPFLAGS $cln_cflags"
  LDFLAGS="$LDFLAGS $cln_libs"
else
  echo "  CLN not found. Please install libcln-dev."
  exit 1
fi

echo "Checking for GiNaC..."
if pkg-config --exists ginac; then
  echo "  Found GiNaC"
  ginac_cflags=$(filter_flags "$(pkg-config --cflags ginac)")
  ginac_libs="$(pkg-config --libs ginac)"
  CPPFLAGS="$CPPFLAGS $ginac_cflags"
  LDFLAGS="$LDFLAGS $ginac_libs"
else
  echo "  GiNaC not found. Please install libginac-dev."
  exit 1
fi

# Optional: remove duplicate -l entries from LDFLAGS
LDFLAGS=$(echo "$LDFLAGS" | tr ' ' '\n' | awk '!seen[$0]++' | tr '\n' ' ')

# Export to Makevars
cat <<EOF > src/Makevars
PKG_CPPFLAGS = $CPPFLAGS
PKG_LIBS = $LDFLAGS
EOF

# Windows stub
cat <<EOF > src/Makevars.win
PKG_CPPFLAGS =
PKG_LIBS =
EOF

echo "Configuration successful."
