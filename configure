#!/bin/sh
# configure script for CRAN-safe fallback static linking of GMP, CLN, and GiNaC

set -e

ARCH=${R_ARCH}
if [ -z "$ARCH" ]; then
  ARCH=$(uname -m)
fi

echo "Detected architecture: $ARCH"

CPPFLAGS=""
LDFLAGS=""

filter_flags() {
  echo "$1" | tr ' ' '\n' | grep -vE '^[-]W$' | tr '\n' ' '
}

if command -v pkg-config >/dev/null 2>&1; then
  echo "Using pkg-config to locate libraries..."

  if pkg-config --exists gmp cln ginac; then
    echo "  Found GMP, CLN, and GiNaC"
    CPPFLAGS=$(filter_flags "$(pkg-config --cflags gmp cln ginac)")
    LDFLAGS=$(pkg-config --libs gmp cln ginac)
  else
    echo "  pkg-config installed but required packages not found. Falling back to bundled libs."
    USE_FALLBACK=1
  fi
else
  echo "pkg-config not available. Falling back to bundled libs."
  USE_FALLBACK=1
fi

if [ "$USE_FALLBACK" = "1" ]; then
  CPPFLAGS="-I../inst/include"
  LDFLAGS="../inst/libs/$ARCH/libgmp.a ../inst/libs/$ARCH/libcln.a ../inst/libs/$ARCH/libginac.a"
fi

# Remove duplicate linker flags
LDFLAGS=$(echo "$LDFLAGS" | tr ' ' '\n' | awk '!seen[$0]++' | tr '\n' ' ')

# Write Makevars
cat <<EOF > src/Makevars
PKG_CPPFLAGS = $CPPFLAGS
PKG_LIBS = $LDFLAGS
EOF

# Makevars.win (Windows users must ensure correct arch dir exists)
cat <<EOF > src/Makevars.win
PKG_CPPFLAGS = -I../inst/include
PKG_LIBS = ../inst/libs/x64/libgmp.a ../inst/libs/x64/libcln.a ../inst/libs/x64/libginac.a
EOF

echo "Configuration complete."
