# configure script for CRAN-safe dynamic linking of GMP, CLN, and GiNaC

set -e

# Check for pkg-config
if ! command -v pkg-config >/dev/null 2>&1; then
  echo "Error: pkg-config is not installed. Please install it to proceed."
  exit 1
fi

# Initialize flags
CPPFLAGS=""
LDFLAGS=""

echo "Checking for GMP..."
if pkg-config --exists gmp; then
  echo "  Found GMP"
  CPPFLAGS="$CPPFLAGS $(pkg-config --cflags gmp)"
  LDFLAGS="$LDFLAGS $(pkg-config --libs gmp)"
else
  echo "  GMP not found. Please install libgmp-dev."
  exit 1
fi

echo "Checking for CLN..."
if pkg-config --exists cln; then
  echo "  Found CLN"
  CPPFLAGS="$CPPFLAGS $(pkg-config --cflags cln)"
  LDFLAGS="$LDFLAGS $(pkg-config --libs cln)"
else
  echo "  CLN not found. Please install libcln-dev."
  exit 1
fi

echo "Checking for GiNaC..."
if pkg-config --exists ginac; then
  echo "  Found GiNaC"
  CPPFLAGS="$CPPFLAGS $(pkg-config --cflags ginac)"
  LDFLAGS="$LDFLAGS $(pkg-config --libs ginac)"
else
  echo "  GiNaC not found. Please install libginac-dev."
  exit 1
fi

# Optional: remove duplicate -l entries from LDFLAGS
LDFLAGS=$(echo "$LDFLAGS" | tr ' ' '\n' | awk '!seen[$0]++' | tr '\n' ' ')

# Export to Makevars
cat <<EOF > src/Makevars
PKG_CPPFLAGS = $CPPFLAGS
PKG_LIBS = $LDFLAGS
EOF

# Windows stub
cat <<EOF > src/Makevars.win
PKG_CPPFLAGS =
PKG_LIBS =
EOF

echo "Configuration successful."

