---
title: "ICU Waiting-Room Capacity Under Bounded Arrivals (Poisson)"
author: "Bogdan Oancea"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: cosmo   
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
vignette: >
  %\VignetteIndexEntry{ICU Waiting-Room Capacity Under Bounded Arrivals (Poisson)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment  = "#>",
  fig.width  = 7,
  fig.height = 5,
  warning = FALSE,
  message = FALSE
)
```

## Overview


Emergency hospitals often operate under hard capacity constraints for intensive care
unit (ICU) waiting rooms. In practice, only a finite number of patients can be held
while awaiting ICU admission; if arrivals exceed this capacity, patients must be
rerouted to other hospitals or delayed, with potentially serious clinical consequences.

In this vignette, we model the number of ICU arrivals per minute using a Poisson
process subject to a hard upper bound. While the Poisson distribution is a standard
starting point for arrival modeling, it is unbounded by construction and therefore
incompatible with finite waiting-room capacity.

Two ad-hoc bounded alternatives are commonly used in practice: 

1. **Truncation**: condition on \(X \le n\) and renormalize.
2. **Capping**: keep probabilities up to \(n-1\) and lump the entire tail \(\Pr(X>n)\) into the boundary value \(n\).

Both approaches enforce bounded support but typically distort moments (mean/variance). 
**Finitization** provides a principled alternative. It constructs a bounded distribution
on \(\{0,\dots,n\}\) whose first \(n\) moments match those of the parent Poisson model
whenever the parameter lies in the Maximum Feasible Parameter Space (MFPS). This
property is crucial because many operational indicators in hospital planning depend
directly on the mean and variance of arrival counts.

## Problem setting and parameterization

Let \(X\) denote the (unbounded) number of ICU arrivals per minute. A natural starting
point is a Poisson model

\[
X \sim \text{Poisson}(\theta), \qquad \mathbb{E}[X] = \theta, \quad \mathrm{Var}(X) = \theta .
\]

We assume that the ICU waiting room can accommodate at most \(n = 2\) patients per
minute; any arrivals beyond this capacity are diverted to another hospital.

### Empirical plausibility of the arrival rate

The choice of \(\theta\) is guided by published ICU admission data rather than chosen
arbitrarily. Large, tertiary-care hospitals routinely observe dozens of ICU-eligible
arrivals per hour when aggregating emergency department referrals, inter-hospital
transfers, and ward escalations.

Publicly available critical care datasets, most notably **MIMIC-IV**, report detailed
timestamps for ICU admissions and emergency department flows at a major academic
medical center. The MIMIC-IV database (Johnson et al., 2023) is a large, de-identified critical care
dataset containing over 70,000 ICU stays with precise admission timestamps. Although
we do not directly analyze patient-level records here, our parameterization is
consistent with arrival intensities observed in such large administrative datasets.

The arrival rate parameter was set to $\theta = 0.95$ arrivals per minute to reflect peak-period ICU demand under operational stress, rather than a long-run hospital average. While aggregate ICU admission rates reported in large administrative datasets such as MIMIC-IV correspond to substantially lower arrivals per minute when averaged over an entire day, short-interval intensities during surge conditions can be markedly higher.

In large tertiary hospitals, ICU-eligible arrivals arise from multiple concurrent streams—including emergency department referrals, ward escalations, and inter-hospital transfers—which can temporarily produce close to one arrival per minute during periods of congestion, epidemic waves, or mass-casualty events. Modeling at the minute level is therefore intended to capture local peak load rather than average utilization.

From a methodological standpoint, choosing $\theta = 0.95$ also places the model near the upper boundary of the Maximum Feasible Parameter Space (MFPS) for a small waiting-room capacity (n = 2). This regime is deliberately challenging: it is precisely where naïve truncation or capping induces substantial distortion of the mean and variance, while finitization remains feasible and moment-preserving. In this sense, $\theta = 0.95$ is not an arbitrary choice but a stress-test parameterization that highlights the operational consequences of bounded modeling decisions under realistic surge conditions.

This choice reflects a realistic operational scenario in which arrivals are monitored
at a fine temporal resolution and diversion decisions must be made rapidly. In this
regime, the tail probability beyond capacity is non-negligible, and moment distortions
under truncation or capping become large enough to materially affect staffing and surge
planning. The example therefore highlights the practical value of finitization in the
clearest possible way.

Larger values of \(n\) lead to smaller tail probabilities and correspondingly smaller
numerical differences, making them less suitable as motivating examples despite being
theoretically valid.

## Three bounded models

We compare three bounded models supported on \(\{0,\dots,n\}\):

- **Finitized Poisson**: `finitization`.
- **Truncated Poisson**: \(\Pr(X=k \mid X\le n)\).
- **Capped Poisson**: keep \(\Pr(X=k)\) for \(k<n\), then set \(\Pr(X=n)\leftarrow \Pr(X=n)+\Pr(X>n)\).

```{r pmf_models}
n <- 2
theta <- 0.95

k_vals <- 0:n

# Parent Poisson pmf on 0..n
pmf0n <- stats::dpois(k_vals, lambda = theta)
p_le_n <- sum(pmf0n)
tail_p <- 1 - p_le_n

# Truncated pmf
pmf_trunc <- pmf0n / p_le_n

# Capped pmf
pmf_cap <- pmf0n
pmf_cap[n + 1] <- pmf_cap[n + 1] + tail_p
pmf_cap <- pmf_cap / sum(pmf_cap)

# Finitized pmf from package
pmf_fin <- finitization::dpois(n = n, theta = theta, val = k_vals)$prob

stopifnot(abs(sum(pmf_trunc) - 1) < 1e-12)
stopifnot(abs(sum(pmf_cap)   - 1) < 1e-12)
stopifnot(abs(sum(pmf_fin)   - 1) < 1e-12)

cat("Tail probability under parent Poisson P(X >", n, ") =",
    signif(tail_p, 6), sprintf("(%.3f%%)\n", 100 * tail_p))
```

## Simulation and moment preservation

We simulate \(no\) minutes from each bounded model and compare empirical mean/variance against the **parent Poisson** moments: \(\mathbb{E}[X]=\theta\) and \(\mathrm{Var}(X)=\theta\).

```{r simulation_moments}
no <- 200000L
set.seed(123)

# Finitized sampling
x_fin <- finitization::rpois(n = n, theta = theta, no = no)

# Truncated sampling (direct sampling on 0..n using truncated pmf)
x_tr  <- sample(k_vals, size = no, replace = TRUE, prob = pmf_trunc)

# Capped sampling
x_cap <- sample(k_vals, size = no, replace = TRUE, prob = pmf_cap)

mu0 <- theta
va0 <- theta

mom <- data.frame(
  Method   = c("Theoretical (unbounded)", "Finitized", "Truncated", "Capped"),
  Mean     = c(mu0, mean(x_fin), mean(x_tr), mean(x_cap)),
  Variance = c(va0, var(x_fin),  var(x_tr),  var(x_cap))
)

mom$Mean_Error_pct <- 100 * (mom$Mean - mu0) / mu0
mom$Var_Error_pct  <- 100 * (mom$Variance - va0) / va0

knitr::kable(
  mom,
  digits = 5,
  caption = sprintf("Moment preservation for arrivals/minute under a hard cap n=%d (theta=%.4f).", n, theta)
)
```

## Why moments matter: downstream operational indicators

Moment distortions propagate into simple planning metrics.

### Expected staffing minutes per day

Suppose each arriving ICU candidate triggers an average of \(S\) clinician minutes (distributed across the day, not “inside the same minute”). Then

\[
\text{StaffMinutes/day} = 1440 \times S \times \mathbb{E}[X].
\]

```{r indicator_staffing}
S <- 12
minutes_per_day <- 1440

ind1 <- data.frame(
  Method = mom$Method,
  StaffMinutes_per_day = minutes_per_day * S * mom$Mean
)
ind1$Error_pct_vs_theoretical <- 100 * (ind1$StaffMinutes_per_day - minutes_per_day * S * mu0) / (minutes_per_day * S * mu0)

knitr::kable(ind1, digits = 2,
             caption = "Indicator 1: expected clinician minutes per day implied by each bounded model.")
```

### Buffer for high-demand staffing

A common buffer heuristic is:

\[
\text{Buffer} = \mathbb{E}[X] + z\sqrt{\mathrm{Var}(X)},
\]

where \(z\) encodes the service level (e.g. \(z=2\)).

```{r indicator_buffer}
z <- 2

buffer <- data.frame(
  Method = mom$Method,
  Buffer_arrivals_per_min = mom$Mean + z * sqrt(mom$Variance)
)
buffer$Error_pct_vs_theoretical <- 100 * (buffer$Buffer_arrivals_per_min - (mu0 + z * sqrt(va0))) / (mu0 + z * sqrt(va0))

knitr::kable(buffer, digits = 5,
             caption = "Indicator 2: buffered arrivals/minute (mean + z·SD) for staffing/surge planning.")
```

### Diversions: overflow minutes/day and expected diverted patients/day

Two diversion metrics under the **parent** process are:

- Overflow minutes/day: \(1440\cdot \Pr(X>n)\)
- Expected diverted patients/day: \(1440\cdot \mathbb{E}[(X-n)_+]\)

```{r diversions}
p_overflow <- 1 - stats::ppois(n, lambda = theta)

# E[(X-n)+] by a finite tail sum (theta<=1 implies fast tail decay)
Kmax <- 80L
kk <- (n + 1L):Kmax
excess_per_min <- sum((kk - n) * stats::dpois(kk, lambda = theta))

div <- data.frame(
  Metric = c("P(X > n) per minute",
             "Overflow minutes per day",
             "Expected diverted patients per day"),
  Value = c(p_overflow,
            minutes_per_day * p_overflow,
            minutes_per_day * excess_per_min)
)

knitr::kable(div, digits = 6, caption = "Diversion metrics under the parent Poisson process.")
```

## Visualization: moment distortion summary

```{r moment_distortion_plot}
err <- rbind(
  Mean_pct_error     = mom$Mean_Error_pct,
  Variance_pct_error = mom$Var_Error_pct
)
colnames(err) <- mom$Method

# Only bounded models
err_plot <- err[, c("Finitized", "Truncated", "Capped"), drop = FALSE]

barplot(
  err_plot,
  beside = TRUE,
  ylab = "Percent error vs parent Poisson moments",
  main = sprintf("Moment distortion under cap n=%d (theta=%.4f)", n, theta),
  legend.text = rownames(err_plot),
  args.legend = list(x = "bottomright", bty = "n")
)
abline(h = 0, lty = 2)
mtext("Finitization preserves moments (up to order n) within MFPS.", side = 3, line = 0.2, cex = 0.8)
```


## Comments on the results

The results highlight the practical consequences of enforcing bounded support through
different modeling choices. With a hard capacity of \(n=2\) and an empirically plausible
arrival intensity \(\theta=0.95\), the parent Poisson distribution assigns a non-negligible
tail probability of approximately 7.1\% to arrivals exceeding capacity. In this regime,
truncation and capping induce substantial distortions in both the mean and the variance.
Truncation underestimates the mean arrival rate by nearly 19\% and the variance by more
than 40\%, while capping still yields errors of approximately 10\% in the mean and 36\%
in the variance. In contrast, the finitized Poisson distribution preserves the first
moments of the parent model to within Monte Carlo error, with deviations below 0.3\%.

These distortions propagate directly into operational indicators. Expected clinician
workload, measured in staffing minutes per day, is underestimated by more than 18\%
under truncation and nearly 10\% under capping, whereas the finitized model remains
accurate. The effect is even more pronounced for high-demand buffers that depend on the
variance: truncation leads to an underestimation of the buffered arrival rate by almost
22\%, and capping by more than 16\%. Such errors would translate into systematic
understaffing and insufficient surge capacity in practice. These findings illustrate
that, when the tail probability beyond capacity is non-negligible, moment preservation is
not a cosmetic property but a critical requirement for reliable planning and risk
management.

## Takeaway

This vignette demonstrates a reproducible workflow:

1. start from a real event stream to estimate events/minute;
2. derive a feasible Poisson intensity \(\theta \le 1\) for small \(n\) under MFPS;
3. compare finitization against truncation/capping under a hard capacity cap;
4. show how moment distortions propagate into staffing and buffering indicators.

It demonstrates that, under hard capacity constraints, the choice of how
bounded support is enforced has material operational consequences. When the parent
Poisson arrival process assigns non-negligible probability mass beyond the capacity
limit, ad-hoc approaches such as truncation and capping substantially distort the mean
and, more critically, the variance of arrivals. These distortions propagate directly
into staffing requirements, surge buffers, and diversion metrics, leading to systematic
underestimation of workload and risk.

Finitization provides a principled alternative: it yields a distribution supported on
\(\{0,\ldots,n\}\) that preserves the moment structure of the parent process within the
Maximum Feasible Parameter Space. In the ICU waiting-room setting considered here,
finitization maintains accurate estimates of expected staffing needs and high-demand
buffers, while truncation and capping would lead to persistent under-preparedness.
Moment preservation is therefore not a theoretical nicety but a practical requirement
for reliable capacity planning under bounded observational regimes.


## References

Johnson, A. E. W., Pollard, T. J., Shen, L., Lehman, L.-w. H., Feng, M., Ghassemi, M.,
Moody, B., Szolovits, P., Celi, L. A., & Mark, R. G. (2023).
MIMIC-IV, a freely accessible electronic health record dataset.
*Scientific Data*, 10, 1–18.

## Session info

```{r session_info}
sessionInfo()
```
